!function(t){var s={}
t.requestAnimationFrame=t.requestAnimationFrame||t.mozRequestAnimationFrame||t.webkitRequestAnimationFrame||t.msRequestAnimationFrame,s.init_display=function(t){t.width=t.parentElement.clientWidth,t.height=240}
var i=function(t){return t*t*t},r=function(t){return 1-(1-t)*(1-t)*(1-t)},e=function(t,s,i,r,e,a,h){return 0>=h?"rgb("+t+","+s+","+i+")":h>=1?"rgb("+r+","+e+","+a+")":"rgb("+Math.round(t+(r-t)*h)+","+Math.round(s+(e-s)*h)+","+Math.round(i+(a-i)*h)+")"},a=function(t,s,i){return 0>=i?t:i>=1?s:t+(s-t)*i},h=function(t,s,i){return 0>=i?t:i>=1?s:{r:Math.round(t.r+(s.r-t.r)*i),g:Math.round(t.g+(s.g-t.g)*i),b:Math.round(t.b+(s.b-t.b)*i)}},n=function(t,s,i,r,e){var a=e-r+1,h=(r+e)/2,n=((t[e]-t[r-1])/a,t[e]-t[r-1]),o=s[e]-s[r-1],d=i[e]-i[r-1],_=(e*(e+1)*(e+e+1)-r*(r-1)*(r+r-1))/6,c=o-h*n,l=_-a*h*h,f=(a*o-a*h*n)/Math.sqrt((a*_-a*a*h*h)*(a*d-n*n))
return[c/l,1-Math.pow(f,6)]}
s.process_pat=function(t){-1===this.start_time&&(this.start_time=t),t-=this.start_time,this.records.push(t)
var s="---"
if(this.records.length>8){for(var i=[0,0,0,0,0,0,0,0],r=0;8>r;++r)i[r]=this.records[this.records.length-1-r]-this.records[this.records.length-2-r]
if(i.sort(function(t,s){return t-s}),i[7]-i[0]<=.5*i[7]){var e=6e4/((i[3]+i[4])/2),a=6e4/((this.records[this.records.length-1]-this.records[this.records.length-9])/8),h=(e+a)/2
s=""+Math.round(h)}}for(;s.length<3;)s=" "+s
this.last_eststr=this.cur_eststr,this.cur_eststr=s,this.pfx_sum[this.records.length-1]=this.pfx_sum[this.records.length-2]+t,this.pfx_wgh[this.records.length-1]=this.pfx_wgh[this.records.length-2]+t*(this.records.length-1),this.pfx_sqr[this.records.length-1]=this.pfx_sqr[this.records.length-2]+t*t
var o,d,_,c=[],l=[]
this.records.length<8?c[1]=1/0:c[1]=n(this.pfx_sum,this.pfx_wgh,this.pfx_sqr,0,this.records.length-1)[1],l[1]=-1
for(var f=2;10>f;++f){d=1/0,_=-1
for(var g=0;g<this.records.length-8;++g)o=this.dyn_pro[g][f-1]+n(this.pfx_sum,this.pfx_wgh,this.pfx_sqr,g+1,this.records.length-1)[1],d>o&&(d=o,_=g)
c[f]=d,l[f]=_}this.dyn_pro.push(c),this.dyn_pro_route.push(l)},s.calc_results=function(){for(var t=1/0,s=-1,i=1;10>i;++i)t>this.dyn_pro[this.dyn_pro.length-1][i]&&(t=this.dyn_pro[this.dyn_pro.length-1][i],s=i)
for(var r=[],e=this.dyn_pro.length-1;-1!==e;e=this.dyn_pro_route[e][s--])r.push(e)
r.push(0),r.reverse(),this.final_results=[]
for(var i=1;i<r.length;++i)this.final_results.push([r[i],6e4/n(this.pfx_sum,this.pfx_wgh,this.pfx_sqr,r[i-1],r[i])[0]])
console.log(this.final_results)},s.draw_history_and_estimation=function(t){var s=this.canvas.clientWidth,e=this.canvas.clientHeight,a=Math.ceil(s/160)+1
this.drawctx.fillStyle="#bbbb88"
for(var h=0;h<Math.min(a,this.records.length-1);++h){this.drawctx.beginPath()
var n=s-160*h-80+160*Math.max(0,Math.pow(1-t/200,3))+10,o=e-e*(this.records[this.records.length-1-h]-this.records[this.records.length-2-h])/1500
if(this.is_finished)if(n=s-160*h-70,300>t){var d=t/300
o+=(e+10-o)*(d*d*(3.5*d-2.5))}else o=e+10
this.drawctx.arc(n,o,10,0,2*Math.PI),this.drawctx.fill(),this.drawctx.fillRect(n-3.09,o,6.18,e-o)}this.is_finished?this.drawctx.fillStyle="rgba(135, 135, 85, "+(1-t/100)+")":this.drawctx.fillStyle="#999955",this.drawctx.font="34px Droid Sans Mono, Source Code Pro, Menlo, Courier New, Monospace",this.drawctx.textBaseline="bottom"
var _=this.drawctx.measureText("Est.")
this.drawctx.fillText("Est.",s-_.width-6,.5*e),this.drawctx.font="64px Droid Sans Mono, Source Code Pro, Menlo, Courier New, Monospace",this.drawctx.textBaseline="top",_=this.drawctx.measureText("m")
for(var h=0;3>h;++h)if(!this.is_finished&&200>t&&this.cur_eststr[h]!==this.last_eststr[h]){var c=this.cur_eststr[h]<this.last_eststr[h]?1:-1
this.drawctx.fillStyle="rgba(135, 135, 85, "+(1-t/200)+")",this.drawctx.fillText(this.last_eststr[h],s-_.width*(3-h)-6,.5*e+20*c*i(t/200)),this.drawctx.fillStyle="rgba(135, 135, 85, "+t/200+")",this.drawctx.fillText(this.cur_eststr[h],s-_.width*(3-h)-6,.5*e-20*c*(1-r(t/200)))}else this.drawctx.fillText(this.cur_eststr[h],s-_.width*(3-h)-6,.5*e)}
var o=function(t){var s=t.v*t.s,i=t.h/60,r=s*(1-Math.abs(i%2-1)),e=0,a=0,h=0
switch(!0){case i>=5:e=s,h=r
break
case i>=4:e=r,h=s
break
case i>=3:a=r,h=s
break
case i>=2:a=s,h=r
break
case i>=1:e=r,a=s
break
case i>=0:e=s,a=r}return{r:Math.floor(255*(e+t.v-s)),g:Math.floor(255*(a+t.v-s)),b:Math.floor(255*(h+t.v-s))}},d=function(t){if(1500>t){var s=300-195e3/1650,i=30+45500/1650,r=50+32500/1650
300>t&&(t=300)
var e=(t-300)/1200
return o({h:s+(300-s)*(1-e),s:(30+(i-30)*e)/100,v:(50+(r-50)*e)/100})}return t>2500&&(t=2500),o({h:300-300*(t-850)/1650,s:(30+70*(t-850)/1650)/100,v:(50+50*(t-850)/1650)/100})},_=function(t){return d(10*t+540)}
s.draw_finishing=function(t){var s=this.canvas.clientWidth,i=this.canvas.clientHeight
if(this.drawctx.fillStyle="rgba(0, 0, 0, 128)",!this._p_x){this._p_x=[4],this._p_y=[i-4]
for(var r=1;r<this.records.length;++r)this._p_x[r]=4+(s-8)*r/(this.records.length-1),this._p_y[r]=i-4-(i-8)*this.records[r]/this.records[this.records.length-1]}for(var e=Math.min(this.records.length,Math.floor((t-300)/1200*this.records.length)),r=0;e>r;++r)this.drawctx.beginPath(),this.drawctx.arc(this._p_x[r],this._p_y[r],4,0,2*Math.PI),this.drawctx.fill(),r>0&&(this.drawctx.beginPath(),this.drawctx.moveTo(this._p_x[r-1],this._p_y[r-1]),this.drawctx.lineTo(this._p_x[r],this._p_y[r]),this.drawctx.stroke())
if(1500>t){var n=(t-300)/1200*this.records.length-e
this.drawctx.beginPath(),this.drawctx.arc(this._p_x[e],this._p_y[e],4*n,0,2*Math.PI),this.drawctx.fill(),e>0&&(this.drawctx.beginPath(),this.drawctx.moveTo(this._p_x[r-1],this._p_y[r-1]),this.drawctx.lineTo(a(this._p_x[r-1],this._p_x[r],n),a(this._p_y[r-1],this._p_y[r],n)),this.drawctx.stroke())}else if(t>2e3){var o=this.is_dragging?Math.max(0,1-(Date.now()-this.drag_start_time)/180):Math.max(0,Math.min(1,(Date.now()-this.drag_end_time-3e3)/180))
e=Math.min(this.final_results.length-1,Math.floor((t-2e3)/180))
for(var d,c=0,r=0;e>=r;++r){var n=Math.min(1,(t-(2e3+180*r))/180),l=_(this.final_results[r][1])
d=this.final_results[r][0]/(this.records.length-1)*s,this.drawctx.fillStyle="rgba("+l.r+","+l.g+","+l.b+", "+.3*n*o+")",this.drawctx.fillRect(c,0,d-c,i),this.drawctx.fillStyle="rgba(0, 0, 0, "+.66*n*o+")",this.drawctx.font="44px Droid Sans Mono, Source Code Pro, Menlo, Courier New, Monospace",this.drawctx.textBaseline="middle"
var f=""+Math.round(this.final_results[r][1]),g=this.drawctx.measureText(f).width
this.drawctx.fillText(f,(c+d-g)/2,i*(.382+.05*r)),this.drawctx.font="24px Droid Sans Mono, Source Code Pro, Menlo, Courier New, Monospace",f=(this.final_results[r][1]-Math.round(this.final_results[r][1])).toFixed(2),"-"!==f[0]&&(f="+"+f),g=this.drawctx.measureText(f).width,this.drawctx.fillText(f,(c+d-g)/2,i*((5>=r?.502:.262)+.05*r)),c=d}t>2e3+180*this.final_results.length&&(this.is_results_displayed=!0)}if(this.is_dragging||this.drag_end_time>=Date.now()-3e3){var l=this.is_dragging?{r:0,g:0,b:0}:h({r:0,g:0,b:0},_(6e4/this.drag_range_est[0]),(Date.now()-this.drag_end_time)/180),u=this.is_dragging?1:Math.min(1,(3e3-Date.now()+this.drag_end_time)/180)
this.drawctx.fillStyle="rgba("+l.r+","+l.g+","+l.b+", "+.3*u+")"
var x=Math.min(this.drag_start_x,this.drag_current_x),w=Math.max(this.drag_start_x,this.drag_current_x)
if(this.drawctx.fillRect(x,0,w-x,i),!this.is_dragging){u=Math.min(u,(Date.now()-this.drag_end_time)/180),this.drawctx.fillStyle="rgba(0, 0, 0, "+.66*u+")",this.drawctx.font="44px Droid Sans Mono, Source Code Pro, Menlo, Courier New, Monospace"
var f=(6e4/this.drag_range_est[0]).toFixed(2),g=this.drawctx.measureText(f).width
this.drawctx.fillText(f,(this.drag_start_x+this.drag_end_x-g)/2,i*(.382+.05*r)),this.drawctx.font="24px Droid Sans Mono, Source Code Pro, Menlo, Courier New, Monospace",f="err "+(100*this.drag_range_est[1]).toFixed(2)+"%",g=this.drawctx.measureText(f).width,this.drawctx.fillText(f,(this.drag_start_x+this.drag_end_x-g)/2,i*((5>=r?.502:.262)+.05*r))}}},s.handle_mousedown=function(s){if(this.is_results_displayed){var i=s.clientX-this.canvas.offsetLeft
this.is_dragging=!0,this.drag_start_x=i,this.drag_current_x=i,this.drag_start_time=Date.now(),this.drag_end_time>=Date.now()-3e3&&(this.drag_start_time-=180),this.drag_end_time=-1,t.requestAnimationFrame(this.ticker)}},s.handle_mousemove=function(t){if(this.is_dragging){var s=t.clientX-this.canvas.offsetLeft
this.drag_current_x=s}},s.handle_mouseup=function(t){if(this.is_results_displayed){var s=this.canvas.clientWidth,i=t.clientX-this.canvas.offsetLeft
this.is_dragging=!1,this.drag_end_time=Date.now(),this.drag_end_x=i
var r,e
r=Math.min(this.drag_start_x,this.drag_end_x),e=Math.max(this.drag_start_x,this.drag_end_x)
var a=Math.min(this.records.length-1,Math.max(0,Math.ceil((r-4)/((s-8)/(this.records.length-1))))),h=Math.min(this.records.length-1,Math.max(0,Math.floor((e-4)/((s-8)/(this.records.length-1)))))
a+1>h&&(this.drag_end_time-=3e3),this.drag_range_est=n(this.pfx_sum,this.pfx_wgh,this.pfx_sqr,a,h)}},s.refresh_display=function(){var s=this.canvas.clientWidth,i=this.canvas.clientHeight,r=Date.now()-this.last_pat
this.drawctx.clearRect(0,0,s,i),this.is_finished?this.drawctx.fillStyle=e(255,255,204,255,255,255,r/100):0===this.records.length?this.drawctx.fillStyle="#ccddaa":1===this.records.length?this.drawctx.fillStyle=e(204,221,170,255,255,204,r/100):this.drawctx.fillStyle="#ffffcc",this.drawctx.fillRect(0,0,s,i),0!==this.records.length&&(this.is_finished?(r>400?this.draw_finishing(r-100):this.draw_history_and_estimation(r),(r<2200+180*this.final_results.length||this.is_dragging||this.drag_end_time>Date.now()-4e3)&&t.requestAnimationFrame(this.ticker)):(this.draw_history_and_estimation(r),200>r&&t.requestAnimationFrame(this.ticker)))},s.pat=function(){this.is_finished||(this.last_pat=Date.now(),this.process_pat(this.last_pat),t.requestAnimationFrame(this.ticker))},s.finish=function(){this.is_finished=!0,this.last_pat=Date.now(),this.calc_results(),t.requestAnimationFrame(this.ticker)},s.create=function(i){if("string"!=typeof i)return void console.log("BPM.create(): id cannot be null")
var r=document.getElementById(i)
if(!r||"CANVAS"!==r.tagName.toUpperCase())return console.log("BPM.create(): id should correspond to a <canvas> element"),!1
s.init_display(r)
var e={}
return e.canvas=r,e.drawctx=r.getContext("2d"),e.last_pat=Date.now(),e.last_eststr="---",e.cur_eststr="---",e.start_time=-1,e.records=[],e.pfx_sum=[],e.pfx_sum[-1]=0,e.pfx_wgh=[],e.pfx_wgh[-1]=0,e.pfx_sqr=[],e.pfx_sqr[-1]=0,e.dyn_pro=[],e.dyn_pro_route=[],e.is_finished=!1,e.is_results_displayed=!1,e.process_pat=s.process_pat,e.calc_results=s.calc_results,e.draw_history_and_estimation=s.draw_history_and_estimation,e.draw_finishing=s.draw_finishing,e.refresh_display=s.refresh_display,e.pat=s.pat,e.finish=s.finish,e.ticker=function(t){return function(){t.refresh_display()}}(e),t.requestAnimationFrame(e.ticker),e.is_dragging=!1,e.drag_start_x=-1,e.drag_start_time=-1,e.drag_current_x=-1,e.drag_end_time=-1,e.drag_range_est=[0,0],e.handle_mousedown=s.handle_mousedown,r.addEventListener("mousedown",function(t){return function(s){t.handle_mousedown(s)}}(e)),e.handle_mousemove=s.handle_mousemove,r.addEventListener("mousemove",function(t){return function(s){t.handle_mousemove(s)}}(e)),e.handle_mouseup=s.handle_mouseup,r.addEventListener("mouseup",function(t){return function(s){t.handle_mouseup(s)}}(e)),e},t.bpm=s}(window)
